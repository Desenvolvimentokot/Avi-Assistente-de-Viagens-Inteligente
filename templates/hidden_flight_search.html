<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Busca de Voos (Visível para Testes)</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f7fa;
        }
        
        .status-container {
            background-color: #fff;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #2681ff;
            margin-top: 0;
        }
        
        .status-info {
            margin-bottom: 15px;
        }
        
        .loading-indicator {
            display: flex;
            align-items: center;
            margin: 10px 0;
        }
        
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #2681ff;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin-right: 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .parameter {
            font-weight: bold;
        }
        
        .results-container {
            background-color: #fff;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        button {
            background-color: #2681ff;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }
        
        button:hover {
            background-color: #1a6dda;
        }
        
        /* Widget container - agora visível para testes */
        #tp-widget-container {
            width: 100%;
            height: 800px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #fff;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="status-container">
        <h1>Busca de Voos (Modo Teste)</h1>
        <div class="status-info">
            <p>Esta página está buscando voos com os seguintes parâmetros:</p>
            <p><span class="parameter">Origem:</span> <span id="origin-display">Carregando...</span></p>
            <p><span class="parameter">Destino:</span> <span id="destination-display">Carregando...</span></p>
            <p><span class="parameter">Data de ida:</span> <span id="departure-display">Carregando...</span></p>
            <p><span class="parameter">Data de volta:</span> <span id="return-display">-</span></p>
            <p><span class="parameter">Passageiros:</span> <span id="adults-display">1</span></p>
        </div>
        <div class="loading-indicator">
            <div class="loading-spinner"></div>
            <p>Buscando voos... Esta página vai se fechar automaticamente quando a busca for concluída.</p>
        </div>
    </div>
    
    <div class="results-container">
        <h2>Resultados encontrados: <span id="results-count">0</span></h2>
        <div id="results-list"></div>
        <button id="close-button" style="display: none;">Fechar esta janela e voltar ao chat</button>
    </div>
    
    <!-- Contêiner para o widget (agora visível) -->
    <div id="tp-widget-container"></div>
    
    <script>
        // Parâmetros da URL
        const urlParams = new URLSearchParams(window.location.search);
        const origin = urlParams.get('origin');
        const destination = urlParams.get('destination');
        const departureDate = urlParams.get('departure_date');
        const returnDate = urlParams.get('return_date');
        const adults = urlParams.get('adults') || '1';
        const sessionId = urlParams.get('session_id');
        
        // Array para armazenar resultados
        let flightResults = [];
        let processing = false;
        
        // Escuta as mensagens do widget
        window.addEventListener('message', function(event) {
            console.log('Recebido evento postMessage:', event.data);
            
            // Verifica se o evento contém resultados de voos
            // Nota: O nome exato do campo pode variar conforme o widget
            if (event.data && (event.data.tpFlightResults || event.data.flights)) {
                const results = event.data.tpFlightResults || event.data.flights;
                console.log('Resultados recebidos:', results);
                
                // Adiciona os resultados ao array
                flightResults = flightResults.concat(results);
                
                // Inicia o processamento se não estiver em andamento
                if (!processing) {
                    processing = true;
                    setTimeout(processResults, 3000); // Espera 3s para coletar mais resultados
                }
            }
        });
        
        function processResults() {
            console.log(`Processando ${flightResults.length} resultados...`);
            
            if (flightResults.length === 0) {
                // Se não há resultados após o tempo de espera, tenta novamente
                processing = false;
                setTimeout(processResults, 2000);
                return;
            }
            
            // Ordena por preço (do mais barato para o mais caro)
            flightResults.sort((a, b) => {
                const priceA = typeof a.price === 'number' ? a.price : parseFloat(a.price);
                const priceB = typeof b.price === 'number' ? b.price : parseFloat(b.price);
                return priceA - priceB;
            });
            
            // Pega os 2 melhores resultados
            const bestFlights = flightResults.slice(0, 2);
            
            // Atualiza a contagem de resultados na página
            document.getElementById('results-count').textContent = bestFlights.length;
            
            // Atualiza a lista de resultados na página
            const resultsList = document.getElementById('results-list');
            resultsList.innerHTML = '';
            
            bestFlights.forEach((flight, index) => {
                const resultItem = document.createElement('div');
                resultItem.style.padding = '10px';
                resultItem.style.margin = '10px 0';
                resultItem.style.backgroundColor = '#f9f9f9';
                resultItem.style.borderRadius = '4px';
                resultItem.style.border = '1px solid #eee';
                
                const airline = flight.airline || 'Companhia aérea';
                const origin = flight.origin || origin || 'Origem';
                const destination = flight.destination || destination || 'Destino';
                const departDate = flight.departure_at ? new Date(flight.departure_at).toLocaleDateString('pt-BR') : 'Data de partida';
                const price = typeof flight.price === 'number' ? flight.price.toFixed(2) : flight.price;
                
                resultItem.innerHTML = `
                    <h3>Opção ${index + 1}: ${airline}</h3>
                    <p><strong>Rota:</strong> ${origin} → ${destination}</p>
                    <p><strong>Data:</strong> ${departDate}</p>
                    <p><strong>Preço:</strong> R$ ${price}</p>
                `;
                
                resultsList.appendChild(resultItem);
            });
            
            // Mostra o botão de fechar
            document.getElementById('close-button').style.display = 'block';
            
            // Envia os resultados para o backend
            sendResultsToBackend(bestFlights);
        }
        
        function sendResultsToBackend(flights) {
            console.log('Enviando resultados para o backend:', flights);
            
            fetch('/api/save-flight-results', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    flights: flights,
                    session_id: sessionId
                })
            })
            .then(response => response.json())
            .then(data => {
                console.log('Resultados enviados com sucesso:', data);
                
                // Fechar esta janela ou redirecionar de volta ao chat
                if (data.success && data.redirect_url) {
                    window.location.href = data.redirect_url;
                }
            })
            .catch(error => {
                console.error('Erro ao enviar resultados:', error);
            });
        }
        
        // Injetar o widget com os parâmetros pré-preenchidos
        window.onload = function() {
            const tpWidgetContainer = document.getElementById('tp-widget-container');
            
            // Preencher informações de parâmetros na página
            document.getElementById('origin-display').textContent = origin || '-';
            document.getElementById('destination-display').textContent = destination || '-';
            document.getElementById('departure-display').textContent = departureDate || '-';
            document.getElementById('return-display').textContent = returnDate || '-';
            document.getElementById('adults-display').textContent = adults || '1';
            
            // Configurar botão de fechar
            const closeButton = document.getElementById('close-button');
            closeButton.addEventListener('click', function() {
                // Redirecionar de volta para o chat
                window.location.href = '/chat';
            });
            
            // Recuperar códigos de cidade do localStorage, se disponíveis
            const dcity = localStorage.getItem('trip_dcity') || origin.toLowerCase();
            const acity = localStorage.getItem('trip_acity') || destination.toLowerCase();
            
            // Construir URL no formato do Trip.com
            const tripUrl = `https://br.trip.com/flights/showfarefirst?dcity=${dcity}&acity=${acity}&ddate=${departureDate}&dairport=${origin}${returnDate ? '&rdate=' + returnDate + '&triptype=rt' : '&triptype=ow'}&class=y&quantity=${adults || 1}&locale=pt-BR&curr=BRL`;

            // Para testes, exibir o URL do Trip.com
            console.log("URL do Trip.com gerada:", tripUrl);
            
            // Criar iframe para o Trip.com
            const iframe = document.createElement('iframe');
            iframe.src = tripUrl;
            iframe.style.width = '100%';
            iframe.style.height = '800px';
            iframe.style.border = 'none';
            
            document.getElementById('tp-widget-container').appendChild(iframe);
            
            // Manter o código antigo como referência, mas não usar mais
            const widgetUrlOld = [
                'https://tp.media/content',
                '?trs=404731',
                '&shmarker=620701',
                '&locale=pt-BR',
                '&curr=BRL',
                '&powered_by=true',
                '&border_radius=0',
                '&plain=true',
                '&color_button=%232681ff',
                '&color_button_text=%23ffffff',
                '&color_border=%232681ff',
                '&promo_id=4132',
                '&campaign_id=121',
                origin ? `&origin=${origin}` : '',
                destination ? `&destination=${destination}` : '',
                departureDate ? `&depart_date=${departureDate}` : '',
                returnDate ? `&return_date=${returnDate}` : '',
                `&adults=${adults}`
            ].filter(Boolean).join('');
            
            // Não usamos mais o widget TravelPayouts, comentando código antigo
            // const script = document.createElement('script');
            // script.async = true;
            // script.src = widgetUrlOld;
            // script.charset = 'utf-8';
            // tpWidgetContainer.appendChild(script);
            
            console.log('Widget carregado com parâmetros:', {
                origin, destination, departureDate, returnDate, adults
            });
            
            // Precisamos criar uma maneira de enviar os dados para nosso sistema
            // Infelizmente, por restrições de segurança cross-origin, não podemos acessar
            // diretamente os resultados do Trip.com pelo iframe
            
            // Adicionamos um botão para o usuário confirmar após fazer a busca no Trip.com
            const confirmButton = document.createElement('button');
            confirmButton.innerHTML = 'Confirmar seleção e voltar ao chat';
            confirmButton.style.display = 'block';
            confirmButton.style.margin = '15px auto';
            confirmButton.style.padding = '12px 24px';
            confirmButton.style.backgroundColor = '#2681ff';
            confirmButton.style.color = 'white';
            confirmButton.style.border = 'none';
            confirmButton.style.borderRadius = '8px';
            confirmButton.style.fontWeight = 'bold';
            confirmButton.style.cursor = 'pointer';
            
            confirmButton.addEventListener('click', function() {
                // Quando o usuário confirmar, usamos dados de exemplo para simular a captura
                const sampleResults = [
                    {
                        airline: 'GOL',
                        price: 'R$ 998,00',
                        departure: departureDate,
                        return: returnDate || '',
                        origin: origin,
                        destination: destination,
                        url: tripUrl
                    }
                ];
                
                console.log('Enviando resultados simulados para o servidor...');
                
                // Envia resultados para o servidor
                fetch('/api/hidden-search/save-results', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        flights: sampleResults,
                        session_id: sessionId
                    })
                })
                .then(response => response.json())
                .then(data => {
                    console.log('Resultados salvos:', data);
                    alert('Busca concluída! Retornando ao chat...');
                    window.location.href = '/chat';
                })
                .catch(error => {
                    console.error('Erro ao salvar resultados:', error);
                    alert('Ocorreu um erro, mas você pode voltar ao chat');
                    window.location.href = '/chat';
                });
            });
            
            // Adiciona o botão ao container
            document.getElementById('tp-widget-container').appendChild(confirmButton);
            
            // Inicia a verificação de resultados após 5 segundos (código antigo)
            // setTimeout(() => {
            //     if (flightResults.length === 0 && !processing) {
            //         processing = true;
            //         processResults();
            //     }
            // }, 5000);
        };
    </script>
</body>
</html>